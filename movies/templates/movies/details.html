{% extends "movies/layout.html" %}
{% block body %}
{% load static %}

<a href="javascript:history.back()">Back to results</a>

<!-- <a href="{% url 'search' %}">Back</a> -->

<div class="container">
   <h1>{{movie.title}}</h1>
   <p>{{movie.year}} &#x2022; {{movie.rated}} &#x2022; {{movie.runtime}}</p>
   <div class="media">
      <img class="align-self-start mr-3" src="{{movie.poster}}" alt="{{movie.title}}" style="width: 16rem">
      <div class="media-body">
         <!-- <h5 class="mt-0">{{movie.title}}</h5> -->
         <h5>Director: {{movie.director}}</h5>
         <h5>Stars: {{movie.actors}}</h5>
         <p>{{movie.plot}}</p>
         <p class="text-muted">{{movie.genre}}</p>
         <p class="card-subtitle mb-2 text-muted">Awards: {{movie.awards}}</p>
         <p class="card-subtitle mb-2 text-muted">Metascore: {{movie.metascore}}</p>
         <p class="card-subtitle mb-2 text-muted">IMDB Rating: {{movie.imdb_rating}}</p>
         <a href="https://www.imdb.com/title/{{movie.imdb_id}}/" target="_blank"
            class="card-subtitle mb-2 text-muted">IMDB: {{movie.imdb_id}}</a>
      </div>
      <!-- Button trigger modal -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
         Watch Trailer
      </button>
      
      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  ...
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary">Save changes</button>
               </div>
            </div>
         </div>
      </div>
   </div>
   <!-- TODO: add / remove button -->
<h2>hello world: {{user}}</h2>
   {% if user in movie.my_list.all %}
   <form action="{% url '_remove_mylist' user %}" method="POST">
      {% csrf_token %}
      <!-- <input type="hidden" name="in" -->
      <button type="submit" class="btn btn-danger">Remove From My List</button>
   </form>
   {% else %}
   <form action="{% url '_add_mylist' %}" method="POST">
      {% csrf_token %}
      <input type="hidden" name="imdb_id" class="form-control" id="imdb_id" value="{{movie.imdb_id}}">
      <input type="hidden" name="title" class="form-control" id="title" value="{{movie.title}}">
      <input type="hidden" name="year" class="form-control" id="year" value="{{movie.year}}">
      <input type="hidden" name="poster" class="form-control" id="poster" value="{{movie.poster}}">
      <input type="hidden" name="type" class="form-control" id="type" value="{{movie.type}}">
      <input type="hidden" name="rated" class="form-control" id="rated" value="{{movie.rated}}">
      <input type="hidden" name="runtime" class="form-control" id="runtime" value="{{movie.runtime}}">
      <input type="hidden" name="director" class="form-control" id="director" value="{{movie.director}}">
      <input type="hidden" name="actors" class="form-control" id="actors" value="{{movie.actors}}">
      <input type="hidden" name="plot" class="form-control" id="plot" value="{{movie.plot}}">
      <input type="hidden" name="genre" class="form-control" id="genre" value="{{movie.genre}}">
      <input type="hidden" name="awards" class="form-control" id="awards" value="{{movie.awards}}">
      <input type="hidden" name="metascore" class="form-control" id="metascore" value="{{movie.metascore}}">
      <input type="hidden" name="imdb_rating" class="form-control" id="imdb_rating" value="{{movie.imdb_rating}}">
      {% if user.is_authenticated %}
      <button type="submit" class="btn btn-success">Add To My List</button>
      {% endif %}
   </form>
   {% endif %}
</div>
<h6>{{movie.title}}</h6>
<h6>Bookmarked?: {{movie.is_bookmarked}}</h6>
<div class="row row-cols-1 row-cols-md-3 g-4">
   <div class="container">
      <div class="row justify-content-center">
         <div class="ms-2 card" style="width: 35rem">
            <div class="card-body rounded">
               <h6 class="card-title">Comments {{comments.count}}</h6>
               {% if user.is_authenticated and movie.is_bookmarked %}
               <form action="{% url 'add-comment' id=movie.id %}" method="POST">
                  {% csrf_token %}
                  <div class="form-group">
                     <textarea class="form-control" name="new_comment" rows="5"
                        placeholder="What would you like to say?"></textarea>
                  </div>
                  <input type="submit" class="btn btn-primary float-end mt-3" value="Comment">
               </form>
               {% endif %}
            </div>
            {% for comment in all_comments %}
            <div class="card-body">
               <p class="card-text">Time: {{comment.timestamp}}</p>
               <p class="card-text">Author: {{comment.author}}</p>
               <p class="card-text">Message: {{comment.message}}</p>
               <!-- <p class="card-text">Posted by: {{comment.user}}</p> -->
            </div>
            {% endfor %}
         </div>
      </div>


   </div>

   <div class="d-flex p-4 justify-content-center">

   </div>
   </br>
   </br>


   <script>
      document.addEventListener('DOMContentLoaded', function () {
         document.querySelectorAll('button').forEach(button => {
            button.onclick = function () {

               // Detects if LIKE button clicked
               if (this.className === "btn btn-secondary float-left" || this.className === "btn btn-danger float-left") {
                  console.log(`Like button clicked. Post number: ${this.parentElement.parentElement.dataset.id}`)

                  const element = event.target
                  const id = element.parentElement.parentElement.dataset.id

                  console.log(`Movie ID: ${id}`)

                  // Update database then HTML
                  fetch(`/like/${id}`), {
                     method: 'POST'
                  }
                  like(element);
               }
            }
         });
      });

      function like(post) {

         // Get current number of likes
         var likes = post.querySelector("#number").innerHTML

         // Increment / deincrement number of likes and change colour of button
         if (post.classList.contains("btn-secondary")) {

            post.className = "btn btn-danger float-left";
            likes++
            post.querySelector("#number").innerHTML = likes

         } else {

            post.className = "btn btn-secondary float-left";
            likes--
            post.querySelector("#number").innerHTML = likes
         }
      }

   </script>

   {% endblock %}
</div>